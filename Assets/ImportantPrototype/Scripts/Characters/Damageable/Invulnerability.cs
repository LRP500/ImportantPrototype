using System;
using Sirenix.OdinInspector;
using UniRx;
using UnityEngine;
using UnityTools.Runtime.Extensions;

namespace ImportantPrototype.Characters
{
    [RequireComponent(typeof(Damageable))]
    public class Invulnerability : MonoBehaviour
    {
        private static readonly int Invulnerable = Animator.StringToHash("Invulnerable");

        [MinValue(0)]
        [SerializeField]
        private float _invulnerability;

        [SerializeField]
        private Animator _animator;
        
        private Damageable _damageable;

        private void Awake()
        {
            _damageable = GetComponent<Damageable>();
        }

        private void OnEnable()
        {
            _damageable.OnDamageTaken
                .Subscribe(_ => SetInvulnerable())
                .AddToDisable(this);
        }

        private void SetInvulnerable()
        {
            Observable.Timer(TimeSpan.FromSeconds(_invulnerability))
                .DoOnSubscribe(() => SetInvulnerable(true))
                .Subscribe(_ => SetInvulnerable(false))
                .AddTo(gameObject);
        }

        public void SetInvulnerable(bool invulnerable)
        {
            _damageable.SetCanDamage(!invulnerable);
            _animator.SetBool(Invulnerable, invulnerable);
        }
    }
}